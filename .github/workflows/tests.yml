name: Tests
permissions:
  contents: read
  pull-requests: write
  
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build
        run: go build ./...

      - name: Test
        run: |
          go test ./... -v -count=1 2>&1 | tee test-output.txt
          echo "TEST_EXIT_CODE=${PIPESTATUS[0]}" >> "$GITHUB_ENV"

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Count results
          PASS=$(grep -c "^--- PASS:" test-output.txt || true)
          FAIL=$(grep -c "^--- FAIL:" test-output.txt || true)
          SKIP=$(grep -c "^--- SKIP:" test-output.txt || true)
          TOTAL=$((PASS + FAIL + SKIP))

          if [ "$FAIL" -gt 0 ]; then
            echo "### :x: $FAIL failed, $PASS passed, $SKIP skipped ($TOTAL total)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### :white_check_mark: $PASS passed, $SKIP skipped ($TOTAL total)" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Package-level summary table
          echo "| Package | Status | Duration |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|----------|" >> "$GITHUB_STEP_SUMMARY"
          grep -E "^(ok|FAIL|---)" test-output.txt | grep -E "^(ok|FAIL)\s" | while read -r line; do
            STATUS=$(echo "$line" | awk '{print $1}')
            PKG=$(echo "$line" | awk '{print $2}')
            DUR=$(echo "$line" | grep -oP '\d+\.\d+s' || echo "-")
            if [ "$STATUS" = "ok" ]; then
              echo "| \`$PKG\` | :white_check_mark: pass | $DUR |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| \`$PKG\` | :x: fail | $DUR |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Show failures if any
          if [ "$FAIL" -gt 0 ]; then
            echo "<details><summary>:x: Failed Tests</summary>" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            grep -A 10 "^--- FAIL:" test-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "</details>" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fail if tests failed
        if: always()
        run: exit ${TEST_EXIT_CODE:-1}
